<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>DeclassifyX</title>
<style>
  body { background:#000; color:#0ff; font-family:'Courier New', monospace; padding:20px; overflow-x:hidden; }
  h1 { color:#0ff; text-align:center; }
  .controls { margin-bottom:20px; display:flex; flex-wrap:wrap; gap:10px; }
  .controls input, .controls select, button {
    padding:8px; background:rgba(0,0,0,0.6); border:1px solid #0ff; color:#0ff; border-radius:4px;
  }
  button:hover { background:#0ff; color:#000; cursor:pointer; }
  #feed { display:flex; flex-direction:column; gap:15px; }
  .post { border-left:4px solid #0ff; padding:15px; background:rgba(0,0,0,0.7); }
  .meta { font-size:12px; color:#0ff; margin-top:5px; }
  #azul { position:fixed; bottom:10px; right:10px; width:80px; animation:float 3s infinite alternate ease-in-out; }
  @keyframes float { 0% { transform: translateY(0px);} 100% { transform: translateY(-20px);} }
</style>
</head>
<body>

<img id="azul" src="azul-cat.png" alt="Azul Hacker Cat">
<h1>üìÇ DeclassifyX</h1>

<div class="controls">
  <input type="text" id="searchQuery" placeholder="Keyword (CIA, nuclear, etc)">
  <input type="text" id="yearFilter" placeholder="Year (1975)">
  <select id="agencyFilter">
    <option value="">All Agencies</option>
    <option value="BILLS">BILLS</option>
    <option value="CREC">CREC</option>
    <option value="USCOURTS">USCOURTS</option>
    <option value="FR">FR</option>
  </select>
  <button id="searchButton">Search</button>
</div>

<div id="feed"></div>

<audio id="bgMusic" loop>
  <source src="synthwave-loop.mp3" type="audio/mpeg">
</audio>

<script>
const API_KEY = "T6cddaelRSPTKEuhmHzZvTqhG8ZB4bYsH6BfmsLO";
const BASE_URL = "https://api.govinfo.gov";
let nextPageToken = null;
let isLoading = false;

// Music autoplay for mobile
const music = document.getElementById("bgMusic");
let musicStarted = false;

// Azul cat pulse
let azulState = false;
let azul = document.getElementById("azul");
setInterval(() => {
  azulState = !azulState;
  azul.src = azulState ? "azul-cat2.png" : "azul-cat.png";
}, 800);

// Keywords for üî• scoring
const keywords = ["classified","secret","nuclear","covert","surveillance","weapon","operation","intelligence"];

// Search button
document.getElementById("searchButton").addEventListener("click", () => {
  if(!musicStarted){ music.play().catch(e=>console.log("Music blocked:",e)); musicStarted=true; }
  nextPageToken = null;
  document.getElementById("feed").innerHTML = "";
  fetchDocs();
});

// Fetch documents
async function fetchDocs(loadMore=false){
  if(isLoading) return;
  isLoading = true;

  const query = document.getElementById("searchQuery").value.trim() || "nuclear";
  const year = document.getElementById("yearFilter").value.trim();
  const agency = document.getElementById("agencyFilter").value;

  const searchBody = {
    query: query,
    pageSize: 10,
    pageToken: nextPageToken || undefined,
    filters: {}
  };
  if(year) searchBody.filters.dateIssued = `${year}-01-01:${year}-12-31`;
  if(agency) searchBody.filters.collection = agency;

  try{
    const res = await fetch(`${BASE_URL}/search?api_key=${API_KEY}`,{
      method:"POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(searchBody)
    });
    const data = await res.json();
    if(!data.results || data.results.length === 0){
      console.log("No results found");
      isLoading=false;
      return;
    }

    nextPageToken = data.nextPageToken || null;

    for(let pkg of data.results){
      const sumRes = await fetch(`${BASE_URL}/packages/${pkg.packageId}/summary?api_key=${API_KEY}`);
      const summary = await sumRes.json();
      const text = (summary.summary || summary.title || "No content").toLowerCase();

      // Compute üî• score
      let score = 0;
      keywords.forEach(k => { if(text.includes(k)) score += 5; });
      if(/\d{4}/.test(text)) score += 2;
      const fireIcons = "üî•".repeat(Math.min(5, Math.ceil(score/5)));

      // Render post
      const div = document.createElement("div");
      div.className = "post";
      div.innerHTML = `
        <div>${summary.title || "Untitled"}</div>
        <div>${summary.summary || "No summary available"}</div>
        <div class="meta">${fireIcons} üìÅ ${summary.collectionCode || "N/A"} | üìÖ ${summary.dateIssued || "Unknown"}
        <br><a href="https://www.govinfo.gov/app/details/${pkg.packageId}" target="_blank" style="color:#f0f">View Source</a></div>
      `;
      document.getElementById("feed").appendChild(div);
    }

  } catch(err){ console.log("Error fetching documents:", err); }

  isLoading=false;
}

// Infinite scroll
window.addEventListener("scroll", () => {
  if((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 300){
    if(nextPageToken && !isLoading) fetchDocs(true);
  }
});
</script>

</body>
</html>
