<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>DeclassifyX</title>
<style>
  body { background:#000; color:#0ff; font-family:'Courier New', monospace; padding:20px; overflow-x:hidden; }
  h1 { color:#0ff; text-align:center; }
  .controls { margin-bottom:20px; display:flex; flex-wrap:wrap; gap:10px; }
  .controls input, .controls select, button {
    padding:8px; background:rgba(0,0,0,0.6); border:1px solid #0ff; color:#0ff; border-radius:4px;
  }
  button:hover { background:#0ff; color:#000; cursor:pointer; }
  #feed { display:flex; flex-direction:column; gap:15px; }
  .post { border-left:4px solid #0ff; padding:15px; background:rgba(0,0,0,0.7); }
  .meta { font-size:12px; color:#0ff; margin-top:5px; }
  #azul { position:fixed; bottom:10px; right:10px; width:80px; animation:float 3s infinite alternate ease-in-out; }
  @keyframes float { 0% { transform: translateY(0px);} 100% { transform: translateY(-20px);} }
</style>
</head>
<body>

<img id="azul" src="azul-cat.png" alt="Azul Hacker Cat">
<h1>ðŸ“‚ DeclassifyX</h1>

<div class="controls">
  <input type="text" id="searchQuery" placeholder="Keyword (CIA, nuclear, etc)">
  <input type="text" id="yearFilter" placeholder="Year (1975)">
  <select id="agencyFilter">
  <option value="">All Intel Sources</option>
  <option value="GAOREPORTS">GAO (Gov Accountability Office)</option>
  <option value="CHRG">Congressional Hearings (Juicy Testimony)</option>
  <option value="FR">Federal Register (Agency Rules)</option>
  <option value="CPRT">Committee Prints (Deep Research)</option>
</select>

  <button id="searchButton">Search</button>
</div>

<div id="feed"></div>

<audio id="bgMusic" loop>
  <source src="synthwave-loop.mp3" type="audio/mpeg">
</audio>

<script>
const API_KEY = "T6cddaelRSPTKEuhmHzZvTqhG8ZB4bYsH6BfmsLO";
const BASE_URL = "https://api.govinfo.gov";
let isLoading = false;

// Music & Cat Logic (Keeping your vibes intact)
const music = document.getElementById("bgMusic");
let musicStarted = false;
let azul = document.getElementById("azul");
let azulState = false;
setInterval(() => {
  azulState = !azulState;
  azul.src = azulState ? "azul-cat2.png" : "azul-cat.png";
}, 800);

document.getElementById("searchButton").addEventListener("click", () => {
  if(!musicStarted){ music.play().catch(e=>console.log(e)); musicStarted=true; }
  fetchDocs();
});

async function fetchDocs() {
  if (isLoading) return;
  isLoading = true;
  
  const feed = document.getElementById("feed");
  const userQuery = document.getElementById("searchQuery").value.trim() || "intelligence";
  const rawYear = document.getElementById("yearFilter").value.trim();
  const agency = document.getElementById("agencyFilter").value;

  // Fix: Extract year
  const yearMatch = rawYear.match(/\d{4}/);
  const year = yearMatch ? yearMatch[0] : "";

  feed.innerHTML = "<div class='post'>ðŸ“¡ ATTEMPTING SECURE BYPASS...</div>";

  // 1. Build a URL-friendly query
  // GovInfo GET search uses 'query' as a string parameter
  let apiQuery = userQuery;
  if (agency) apiQuery += ` AND collection:${agency}`;
  if (year) apiQuery += ` AND publishdate:${year}`;

  // 2. Use a different, simpler proxy (Corsproxy.io) 
  // This one is often much better for iPhone/GitHub Pages
  const targetUrl = `https://api.govinfo.gov/search?query=${encodeURIComponent(apiQuery)}&pageSize=10&api_key=${API_KEY}`;
  const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(targetUrl)}`;

  try {
    const res = await fetch(proxyUrl);
    if (!res.ok) throw new Error("Server Rejected Connection");
    
    const data = await res.json();

    if (!data.results || data.results.length === 0) {
      feed.innerHTML = "<div class='post'>ðŸ›‘ NO INTEL FOUND. THE SYSTEM IS EMPTY.</div>";
    } else {
      feed.innerHTML = "";
      data.results.forEach(pkg => {
        // Find "Mind-Blowing" Keywords for the ðŸ”¥ score
        let score = 0;
        const checkText = (pkg.title + pkg.snippet).toLowerCase();
        keywords.forEach(k => { if(checkText.includes(k)) score++; });
        const fireIcons = "ðŸ”¥".repeat(Math.min(5, score));

        const div = document.createElement("div");
        div.className = "post";
        div.innerHTML = `
          <div style="color:#0ff; font-size:10px;">[DATA LEAK] ${fireIcons}</div>
          <div style="font-weight:bold; color:#f0f; margin:5px 0;">${pkg.title}</div>
          <p style="font-size:14px; color:#0ff; opacity:0.8;">${pkg.snippet || "No snippet available. Open file to read..."}</p>
          <div class="meta">
            ðŸ“… ${pkg.dateIssued} | <a href="https://www.govinfo.gov/app/details/${pkg.packageId}" target="_blank" style="color:#fff; text-decoration:none; border:1px solid #0ff; padding:2px;">[ACCESS]</a>
          </div>
        `;
        feed.appendChild(div);
      });
    }
  } catch (err) {
    feed.innerHTML = `<div class='post' style='color:red;'>ðŸ”´ CONNECTION ERROR. <br> The API is blocking the mobile request.</div>`;
  }
  isLoading = false;
}

</script>

</body>
</html>
